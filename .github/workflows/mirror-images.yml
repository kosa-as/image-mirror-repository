name: Mirror third-party images to GHCR

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * *"   # 每天 03:00 UTC

permissions:
  contents: write    # 方案B需要创建/更新 Release
  packages: write

env:
  TARGET_REGISTRY: ghcr.io
  TARGET_OWNER: ${{ github.repository_owner }}
  TARGET_NAMESPACE: mirror

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.TARGET_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 可选：Docker Hub 限流时使用
      - name: Log in to Docker Hub (optional)
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${DOCKERHUB_USERNAME:-}" && -n "${DOCKERHUB_TOKEN:-}" ]]; then
            echo "${DOCKERHUB_TOKEN}" | docker login docker.io -u "${DOCKERHUB_USERNAME}" --password-stdin
            echo "Docker Hub login: OK"
          else
            echo "Docker Hub login: skipped (missing secrets)"
          fi

      - name: Mirror images to GHCR and export tar
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out

          IMAGES=(
            "docker.io/bitnamilegacy/os-shell:12-debian-12-r51"
            "docker.io/bitnamilegacy/kafka:4.0.0-debian-12-r10"
            "docker.io/bitnamilegacy/kubectl:1.33.4-debian-12-r0"
            "docker.io/bitnamilegacy/jmx-exporter:1.4.0-debian-12-r0"
            "docker.io/library/registry:2"
          )

          for SRC in "${IMAGES[@]}"; do
            REGISTRY="${SRC%%/*}"      # docker.io
            REST="${SRC#*/}"           # bitnamilegacy/kafka:...
            NS_REPO="${REST%%:*}"      # bitnamilegacy/kafka
            TAG="${SRC##*:}"           # 4.0.0-debian-12-r10

            DST="${TARGET_REGISTRY}/${TARGET_OWNER}/${TARGET_NAMESPACE}/${REGISTRY}/${NS_REPO}:${TAG}"

            echo "==> Pull  : ${SRC}"
            docker pull "${SRC}"

            echo "==> Tag   : ${SRC} -> ${DST}"
            docker tag "${SRC}" "${DST}"

            echo "==> Push  : ${DST}"
            docker push "${DST}"

            # 导出为 tar（供浏览器下载）
            # 文件名做安全化：把 / 和 : 替换成 _
            SAFE_NAME="$(echo "${SRC}" | sed 's#[/:]#_#g').tar"
            TAR_PATH="out/${SAFE_NAME}"

            echo "==> Export: ${SRC} -> ${TAR_PATH}"
            docker save -o "${TAR_PATH}" "${SRC}"

            echo "==> Done  : ${SRC}"
            echo
          done

      # 生成 Release Tag，例如 mirror-20260117
      - name: Compute release tag
        id: rel
        shell: bash
        run: |
          set -euo pipefail
          DATE_UTC="$(date -u +%Y%m%d)"
          echo "tag=mirror-${DATE_UTC}" >> "$GITHUB_OUTPUT"
          echo "name=Mirror images ${DATE_UTC}" >> "$GITHUB_OUTPUT"

      - name: Publish to GitHub Release (scheme B)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.tag }}
          name: ${{ steps.rel.outputs.name }}
          files: out/*.tar
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
