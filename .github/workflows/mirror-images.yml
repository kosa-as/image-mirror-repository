name: Mirror third-party images to GHCR

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * *"   # 每天 03:00 UTC；你可按需调整

permissions:
  contents: read
  packages: write

env:
  TARGET_REGISTRY: ghcr.io
  TARGET_OWNER: ${{ github.repository_owner }}
  # 可选：统一加前缀，便于区分这是镜像缓存
  TARGET_NAMESPACE: mirror

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.TARGET_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 可选：如果你拉 Docker Hub 经常限流，可配置 DOCKERHUB_USERNAME / DOCKERHUB_TOKEN
      - name: Log in to Docker Hub (optional)
        if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Mirror images
        shell: bash
        run: |
          set -euo pipefail

          # 你要转存的镜像清单（可自行增删）
          IMAGES=(
            "docker.io/bitnamilegacy/os-shell:12-debian-12-r51"
            "docker.io/bitnamilegacy/kafka:4.0.0-debian-12-r10"
            "docker.io/bitnamilegacy/kubectl:1.33.4-debian-12-r0"
            "docker.io/bitnamilegacy/jmx-exporter:1.4.0-debian-12-r0"
            "docker.io/library/registry:2"
          )

          for SRC in "${IMAGES[@]}"; do
            # 解析：registry/repo:tag
            REGISTRY="${SRC%%/*}"                  # docker.io
            REST="${SRC#*/}"                       # bitnamilegacy/os-shell:...
            REPO_TAG="${REST#*/}"                  # os-shell:...  (当REST是library/registry:2时会变成 registry:2)
            NS_REPO="${REST%%:*}"                  # bitnamilegacy/os-shell  或 library/registry
            TAG="${SRC##*:}"                       # tag

            # 目标命名：ghcr.io/<owner>/<namespace>/<原registry>/<原namespace>/<repo>:<tag>
            # 这样能避免不同上游 registry / namespace 冲突
            # 示例：ghcr.io/acme/mirror/docker.io/bitnamilegacy/os-shell:12-debian-12-r51
            DST="${TARGET_REGISTRY}/${TARGET_OWNER}/${TARGET_NAMESPACE}/${REGISTRY}/${NS_REPO}:${TAG}"

            echo "==> Pull  : ${SRC}"
            docker pull "${SRC}"

            echo "==> Tag   : ${SRC} -> ${DST}"
            docker tag "${SRC}" "${DST}"

            echo "==> Push  : ${DST}"
            docker push "${DST}"

            echo "==> Done  : ${SRC}"
            echo
          done
